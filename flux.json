{
    "extends": [
        "github>mailerlite/renovate-config:base"
    ],
    "enabledManagers": [
        "regex",
        "github-actions",
        "kubernetes",
        "flux"
    ],
    "flux": {
        "managerFilePatterns": [
            "/mailer.+\\.ya?ml$/",
            "/clusters?/.+\\.ya?ml$/",
            "/base/.+\\.ya?ml$/"
        ]
    },
    "schedule": ["* 5 * * 1"],
    "customManagers": [
        {
            "customType": "regex",
            "managerFilePatterns": [
                "/mailer.+\\.ya?ml$/",
                "/clusters?/.+\\.ya?ml$/",
                "/base/.+\\.ya?ml$/"
            ],
            "matchStrings": [
                "# renovate: datasource=(?<datasource>.*?) registryUrl=(?<registryUrl>.*?) chart=(?<depName>.*)\n *version: (?<currentValue>.*)",
                "# renovate: datasource=(?<datasource>.*?) depName=(?<depName>.*?)?(?:\n.*?)(?:\n.*?)?tag: .*?(?<currentValue>.*)",
                "# renovate: datasource=(?<datasource>.*?) depName=(?<depName>.*?)?\n.*?image: .*?:(?<currentValue>.*)"
            ],
            "datasourceTemplate": "docker"
        },
        {
            "customType": "regex",
            "managerFilePatterns": [
                "/mailer.+\\.ya?ml$/",
                "/clusters?/.+\\.ya?ml$/",
                "/base/.+\\.ya?ml$/"
            ],
            "matchStrings": [
                "registryUrl=(?<registryUrl>.*?) chart=(?<depName>.*)\n *version: (?<currentValue>.*)"
            ],
            "datasourceTemplate": "helm"
        },
        {
            "customType": "regex",
            "managerFilePatterns": [
                "/^\\.pre-commit-config\\.ya?ml$/"
            ],
            "matchStrings": [
                "# renovate: datasource=(?<datasource>.*?) depName=(?<depName>.*?)?\n.*?rev: .*?(?<currentValue>.*)"
            ],
            "datasourceTemplate": "github-releases"
        }
    ],
    "packageRules": [
        {
            "description": "Groot - high priority, always available, automerge",
            "matchPackageNames": ["europe-docker.pkg.dev/mailerlitehub/groot/groot"],
            "automerge": true,
            "automergeType": "pr",
            "platformAutomerge": true,
            "addLabels": ["groot", "automerge"],
            "schedule": ["* * * * *"],
            "prPriority": 100,
            "minimumReleaseAge": "0 days"
        },
        {
            "description": "Helm charts - separate PRs per package, split by environment",
            "matchDatasources": ["helm"],
            "separateMinorPatch": true,
            "ignoreDeprecated": true,
            "additionalBranchPrefix": "{{#if (containsString packageFileDir 'clusters/staging')}}staging{{else}}{{#if (containsString packageFileDir 'clusters/dev')}}dev{{else}}{{#if (containsString packageFileDir 'clusters/prod')}}prod{{else}}{{#if (containsString packageFileDir 'base/')}}base{{/if}}{{/if}}{{/if}}{{/if}}-",
            "addLabels": ["helm", "{{#if (containsString packageFileDir 'clusters/staging')}}staging{{/if}}", "{{#if (containsString packageFileDir 'clusters/dev')}}dev{{/if}}", "{{#if (containsString packageFileDir 'clusters/prod')}}prod{{/if}}", "{{#if (containsString packageFileDir 'base/')}}base{{/if}}"]
        },
        {
            "description": "Docker images - separate PRs per package, split by environment",
            "matchDatasources": ["docker"],
            "separateMinorPatch": true,
            "ignoreDeprecated": true,
            "additionalBranchPrefix": "{{#if (containsString packageFileDir 'clusters/staging')}}staging{{else}}{{#if (containsString packageFileDir 'clusters/dev')}}dev{{else}}{{#if (containsString packageFileDir 'clusters/prod')}}prod{{else}}{{#if (containsString packageFileDir 'base/')}}base{{/if}}{{/if}}{{/if}}{{/if}}-",
            "addLabels": ["docker", "{{#if (containsString packageFileDir 'clusters/staging')}}staging{{/if}}", "{{#if (containsString packageFileDir 'clusters/dev')}}dev{{/if}}", "{{#if (containsString packageFileDir 'clusters/prod')}}prod{{/if}}", "{{#if (containsString packageFileDir 'base/')}}base{{/if}}"]
        },
        {
            "description": "VictoriaMetrics - split by environment",
            "matchPackagePatterns": ["^victoriametrics"],
            "additionalBranchPrefix": "{{#if (containsString packageFileDir 'clusters/staging')}}staging{{else}}{{#if (containsString packageFileDir 'clusters/dev')}}dev{{else}}{{#if (containsString packageFileDir 'clusters/prod')}}prod{{else}}{{#if (containsString packageFileDir 'base/')}}base{{/if}}{{/if}}{{/if}}{{/if}}-",
            "addLabels": ["VictoriaMetrics", "{{#if (containsString packageFileDir 'clusters/staging')}}staging{{/if}}", "{{#if (containsString packageFileDir 'clusters/dev')}}dev{{/if}}", "{{#if (containsString packageFileDir 'clusters/prod')}}prod{{/if}}", "{{#if (containsString packageFileDir 'base/')}}base{{/if}}"]
        },
        {
            "description": "app-template patch updates",
            "groupName": "app-template patch dependencies",
            "groupSlug": "app-template-patch",
            "matchPackageNames": ["app-template"],
            "matchUpdateTypes": ["patch"]
        },
        {
            "description": "app-template minor updates",
            "groupName": "app-template minor dependencies",
            "groupSlug": "app-template-minor",
            "matchPackageNames": ["app-template"],
            "matchUpdateTypes": ["minor"]
        }
    ]
}
